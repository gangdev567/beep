<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Insert title here</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="canonical" href="https://getbootstrap.kr/docs/5.3/examples/footers/">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.15.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://kit.fontawesome.com/1306328925.js" crossorigin="anonymous"></script>
  <style>
    .cnter {
      display: grid;
      grid-template-columns: 1fr 5.5fr 1.5fr;
      height: (100vh - 62px);
    }
    .void {
      height: 62px;
    }
    nav.fixed-top {
      max-height: 62px;
      overflow: hidden;
      flex-wrap: nowrap;
    }
    ul.nav {
      overflow: hidden;
      flex-wrap: nowrap;
    }
    .chat-container {
      position: fixed;
      height: 100%;
      width: 1.5fr;
      overflow-y: auto; /* ì±„íŒ…ì°½ì´ ë‚´ìš©ì„ ë„˜ì–´ê°ˆ ê²½ìš° ìŠ¤í¬ë¡¤ í‘œì‹œ */
      word-break: break-all;
      flex-direction: column;
      justify-content: flex-end;
    }
    .scrollbarContainer::-webkit-scrollbar {
      display: none;
    }

    .cnter-item {
        height: 100vh;
    }
    
    input.content {
      margin-top: auto;
    }
    .scrollbarContainer {
      height: calc(86vh);
      overflow-y: scroll;
    }
  </style>
</head>
<body>
<div th:replace="~{/layout/fragments :: myheader}"></div>
<div class="void"></div>
<main class="cnter">
  <div class="cnter-item">
    <div>
      <h2>íŒ”ë¡œìš° ëª©ë¡</h2>
      <p class="d-none">Total Follow Count: <span id="countByFollow"></span></p>
      <ul id="followList">
      </ul>
    </div>
  </div>
  <div class="cnter-item">
    <!-- ìŠ¤íŠ¸ë¦¬ë° í”Œë ˆì´ì–´ ì¶”ê°€ -->
    <div class="video-container">
      <video id="video" controls autoplay></video>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const videoSrc = [[${streamingUrl}]]; // ì„œë²„ë¡œë¶€í„° ë°›ì€ ìŠ¤íŠ¸ë¦¬ë° URL
      const video = document.getElementById('video');

      if(Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(videoSrc);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoSrc;
      }
      /*]]>*/
    </script>
    <!-- ë¡œê·¸ì¸ ì •ë³´ í™•ì¸í•˜ê¸°(í…ŒìŠ¤íŠ¸ìš©) // TODO: ë‚˜ì¤‘ì— ê°ì¶°ì•¼í•©ë‹ˆë‹¤.-->
    <input class="form-control d-none" id="authentication" th:value="${#authentication != null ? #authentication.name : null}" />
    <input class="" id="channelUserId" th:value="${streamer.userName}" />
    <input class="" id="channelUserNickname" th:value="${streamer.userNickname}" />
    <input class="" id="loginUserId" th:value="${userAccount.userName}"/>

    <div class="row">
      <p>íŒ”ë¡œì›Œ : <span id="countByFollower"></span></p>
      <ul id="followerList"></ul>

      <div class="col-md-6 offset-md-5">
        <div class="d-flex justify-content-end">
          <button id="followBtn" type="button" class="btn btn-dark d-none" onclick="follow()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.0198 6.77894C8.94243 3.98296 3.5 4.39829 3.5 8.6267C3.5 10.6135 4.97427 13.2199 9.20416 15.9063C9.30036 15.9674 9.6265 16.1413 10 16.1427C10.3735 16.1442 10.6793 15.9801 10.7622 15.9276C15.0179 13.2337 16.5 10.6188 16.5 8.6267C16.5 4.42263 11.1031 3.96638 10.0198 6.77894Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
            </svg>
            íŒ”ë¡œìš° ë“±ë¡
          </button>

          <button id="unfollowBtn" type="button" class="btn btn-dark d-none" onclick="unfollow()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.0198 6.77894C8.94243 3.98296 3.5 4.39829 3.5 8.6267C3.5 10.6135 4.97427 13.2199 9.20416 15.9063C9.30036 15.9674 9.6265 16.1413 10 16.1427C10.3735 16.1442 10.6793 15.9801 10.7622 15.9276C15.0179 13.2337 16.5 10.6188 16.5 8.6267C16.5 4.42263 11.1031 3.96638 10.0198 6.77894Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
            </svg>
            íŒ”ë¡œìš° ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

  </div>


<div class="cnter-item">
    <div class="chat-container">
        <div class="scrollbarContainer">
            <span>ë©”ì„¸ì§€</span>
            <div class="msgArea"></div>
        </div>
        <div class="input-group input-group-sm">
            <textarea type="text" placeholder="ë³´ë‚¼ ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." class="form-control content" rows="3"></textarea>
            <button type="button" class="sendBtn btn text-white" style="background-color: blueviolet;" onclick="sendMsg()">ì „ì†¡ì´ë¼ë„¤</button>
        </div>
    </div>
</div>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="/docs/5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<script th:inline="javascript">

  function enterRoom(socket){
    var enterMsg={"type" : "ENTER","roomId":[[${room.roomId}]],"sender":[[${userAccount.userNickname}]],"msg":""};
    console.log(enterMsg);
    socket.send(JSON.stringify(enterMsg));
    let user = [[${userAccount.userNickname}]];
    let entMsg = user + "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! BEEP!! BEEP!! BEEP!!"
    let msgArea = document.querySelector('.msgArea');
    let newMsg = document.createElement('div');
    if(user !== 'anonymousUser') {
        newMsg.innerText = entMsg;
        msgArea.append(newMsg);    
    } else if(user === 'anonymousUser') {
        newMsg.innerText = [[${streamer.userNickname}]] + "ë‹˜ì˜ ë°©ì†¡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!"
        msgArea.append(newMsg);
    }
  }
  let socket = new WebSocket("ws://192.168.20.26:8081/ws/chat");

  socket.onopen = function (e) {
    console.log('open server!')
    enterRoom(socket);
  };
  socket.onclose = function(e){
    console.log('disconnet');
  }

  socket.onerror = function (e){
    console.log(e);
  }

  function updateScroll() {
    var scroll = document.querySelector('.scrollbarContainer');
    scroll.scrollTop = scroll.scrollHeight;
  }

  //ë©”ì„¸ì§€ ìˆ˜ì‹ í–ˆì„ ë•Œ ì´ë²¤íŠ¸.
  socket.onmessage = function (e) {
    console.log(e.data);
    let msgArea = document.querySelector('.msgArea');
    let newMsg = document.createElement('div');
    //JSON.parse()ëŠ” JSON ë¬¸ìì—´ì„ javascript ë¦¬í„°ëŸ´ ê°ì²´ í˜¹ì€ ë°°ì—´ë¡œ ë³€í™˜í•¨
    let message = JSON.parse(e.data);
    
    // senderê°€ í•´ë‹¹ ì±„ë„ì˜ ìŠ¤íŠ¸ë¦¬ë¨¸ì¼ ê²½ìš° ê°•ì¡°í•´ì„œ í‘œì‹œ
    if(message.sender === [[${streamer.userNickname}]]) {
        newMsg.innerHTML = 'ğŸ‘‘' + '<strong>' + message.sender + ':' + message.msg + '</strong>';        
    } else {
        newMsg.innerHTML = message.sender +': ' + message.msg;
    }
    if(message.type === 'TALK') {
      msgArea.append(newMsg);
    }

    updateScroll();

  }

  document.addEventListener('keydown', function(event) {
    if (event.keyCode === 13) {
        event.preventDefault(); // ê¸°ë³¸ Enter í–‰ë™ ë§‰ê¸° (í¼ ì „ì†¡ ë“±)
        sendMsg();
    }
  });
  //ë©”ì„¸ì§€ ë³´ë‚´ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë–„..
  function sendMsg() {
    let content=document.querySelector('.content').value;
    if(content === '') {
        return;
    }
    let userId = [[${userAccount.userNickname}]];
    console.log(userId);
    
    if([[${userAccount.userNickname}]] === 'anonymousUser'){
        document.querySelector('.content').value = 'ì±„íŒ…ì€ ë¡œê·¸ì¸ ì´í›„ ì´ìš©í•˜ ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        document.querySelector('.content').setAttribute('readonly', 'true');
        return;
    }
    
    var talkMsg = {
            "type" : "TALK",
            "roomId":[[${room.roomId}]] ,
            "sender":[[${userAccount.userNickname}]],
            "msg":content};
    //JSON.stringify(quitMsg) -> json í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ì„œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ë©”ì„œë“œ.
    socket.send(JSON.stringify(talkMsg));
    
    document.querySelector('.content').value = '';

  }

  window.addEventListener('beforeunload', handlePageUnload);

  function quit(){
    var quitMsg={"type" : "QUIT","roomId":[[${room.roomId}]] ,"sender":[[${userAccount.userNickname}]],"msg":""};
    //JSON.stringify(quitMsg) -> json í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ì„œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ë©”ì„œë“œ.
    socket.send(JSON.stringify(quitMsg));
    socket.close();
    location.href="/";
  }

  function handlePageUnload() {
    quit();
  }


</script>
<script th:inline="javascript">
  const authentication = /*[[${#authentication.name}]]*/ null;
</script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/js/follow.js"></script>
<script src="/js/broadcast.js"></script>
</body>
</html>