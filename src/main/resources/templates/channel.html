<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Insert title here</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="canonical" href="https://getbootstrap.kr/docs/5.3/examples/footers/">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.15.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://kit.fontawesome.com/1306328925.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/nav.css" >
  <link rel="stylesheet" href="/css/switch.css" >
  <style>
    .flex-right {
      margin-left: auto;
    }
          
    .cnter {
      display: grid;
      grid-template-columns: 1fr 5.5fr 1.5fr;
      height: (100vh - 62px);
    }
    .void {
      height: 62px;
    }
    nav.fixed-top {
      max-height: 62px;
      overflow: hidden;
      flex-wrap: nowrap;
    }
    ul.nav {
      overflow: hidden;
      flex-wrap: nowrap;
    }
    .chat-container {
      position: fixed;
      height: 100%;
      width: 1.5fr;
      overflow-y: auto; /* ì±„íŒ…ì°½ì´ ë‚´ìš©ì„ ë„˜ì–´ê°ˆ ê²½ìš° ìŠ¤í¬ë¡¤ í‘œì‹œ */
      word-break: break-all;
      flex-direction: column;
      justify-content: flex-end;
    }
    .scrollbarContainer::-webkit-scrollbar {
      display: none;
    }

    .cnter-item {
        height: 100vh;
        
    }
    
    input.content {
      margin-top: auto;
    }
    .scrollbarContainer {
      height: calc(85vh);
      overflow-y: scroll;
    }
    .flexAndBetween {
        display: flex;
        justify-content: space-between;
    }
  </style>
</head>
<body>
<div th:replace="~{/layout/fragments :: myheader}"></div>
<div class="void" >
    <input class="dummy"d-none th:value="${channel.channelId}" font-data="medium">
</div>
<main class="cnter">
  <div class="cnter-item">
    <div>
      <h2>íŒ”ë¡œìš° ëª©ë¡</h2>
      <p class="d-none">Total Follow Count: <span id="countByFollow"></span></p>
      <ul id="followList" class="list-group">
      </ul>
    </div>
  </div>
  <div class="cnter-item">
    <!-- ìŠ¤íŠ¸ë¦¬ë° í”Œë ˆì´ì–´ ì¶”ê°€ -->
    <div class="video-container">
      <video id="video" controls autoplay></video>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const videoSrc = [[${streamingUrl}]]; // ì„œë²„ë¡œë¶€í„° ë°›ì€ ìŠ¤íŠ¸ë¦¬ë° URL
      const video = document.getElementById('video');

      if(Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(videoSrc);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = videoSrc;
      }
      /*]]>*/
    </script>
    <!-- ë¡œê·¸ì¸ ì •ë³´ í™•ì¸í•˜ê¸°(í…ŒìŠ¤íŠ¸ìš©) // TODO: ë‚˜ì¤‘ì— ê°ì¶°ì•¼í•©ë‹ˆë‹¤.-->
    <input class="form-control d-none" id="authentication" th:value="${#authentication != null ? #authentication.name : null}" />
    <input class="" id="channelUserId" th:value="${streamer.userId}" />
    <input class="" id="channelUserNickname" th:value="${streamer.userNickname}" />
    <input class="" id="loginUserId" th:value="${userAccount.userId}"/>

    <div class="row">
      <p>íŒ”ë¡œì›Œ : <span id="countByFollower"></span></p>
      <ul id="followerList"></ul>

      <div class="col-md-6 offset-md-5">
        <div class="d-flex justify-content-end">
          <button id="followBtn" type="button" class="btn btn-dark d-none" onclick="follow()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.0198 6.77894C8.94243 3.98296 3.5 4.39829 3.5 8.6267C3.5 10.6135 4.97427 13.2199 9.20416 15.9063C9.30036 15.9674 9.6265 16.1413 10 16.1427C10.3735 16.1442 10.6793 15.9801 10.7622 15.9276C15.0179 13.2337 16.5 10.6188 16.5 8.6267C16.5 4.42263 11.1031 3.96638 10.0198 6.77894Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
            </svg>
            íŒ”ë¡œìš° ë“±ë¡
          </button>

          <button id="unfollowBtn" type="button" class="btn btn-dark d-none" onclick="unfollow()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.0198 6.77894C8.94243 3.98296 3.5 4.39829 3.5 8.6267C3.5 10.6135 4.97427 13.2199 9.20416 15.9063C9.30036 15.9674 9.6265 16.1413 10 16.1427C10.3735 16.1442 10.6793 15.9801 10.7622 15.9276C15.0179 13.2337 16.5 10.6188 16.5 8.6267C16.5 4.42263 11.1031 3.96638 10.0198 6.77894Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
            </svg>
            íŒ”ë¡œìš° ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

  </div>


<div class="cnter-item">
    <div class="chat-container">
        <div class="scrollbarContainer">
            <span>ë©”ì„¸ì§€</span>
            <div class="msgArea"></div>
        </div>
        <div class="input-group input-group-sm">
            <textarea type="text" placeholder="ë³´ë‚¼ ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." class="form-control content" rows="2" style="margin-bottom: 5px;" maxlength="1000"></textarea>
        </div>
        <div class="flexAndBetween">
            <input class="chatState" style="display: none;" th:value="${chatState}">
            <div class="dropup">
                <button type="button" class="btn btn-sm" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <svg width="20" height="20" viewBox="0 0 20 20" focusable="false" aria-hidden="true" role="presentation" style="margin-right: 0%;">
                        <path d="M10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"></path>
                        <path fill-rule="evenodd" d="M9 2h2a2.01 2.01 0 0 0 1.235 1.855l.53.22a2.01 
                        2.01 0 0 0 2.185-.439l1.414 1.414a2.01 2.01 0 0 0-.439 2.185l.22.53A2.01 2.01 
                        0 0 0 18 9v2a2.01 2.01 0 0 0-1.855 1.235l-.22.53a2.01 2.01 0 0 0 .44 2.185l-1.415 
                        1.414a2.01 2.01 0 0 0-2.184-.439l-.531.22A2.01 2.01 0 0 0 11 18H9a2.01 2.01 0 0 
                        0-1.235-1.854l-.53-.22a2.009 2.009 0 0 0-2.185.438L3.636 14.95a2.009 2.009 0 0 
                        0 .438-2.184l-.22-.531A2.01 2.01 0 0 0 2 11V9c.809 0 1.545-.487 1.854-1.235l.22-.53a2.009 
                        2.009 0 0 0-.438-2.185L5.05 3.636a2.01 2.01 0 0 0 2.185.438l.53-.22A2.01 2.01 0 0 0 9 
                        2zm-4 8 1.464 3.536L10 15l3.535-1.464L15 10l-1.465-3.536L10 5 6.464 6.464 5 10z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <ul class="dropdown-menu" style="width: 15vw">
                    <th:block th:if="${userAccount.userId == streamer.userId}">
                        <li class="tmtm">
                            <div class="wrapper flexAndBetween">
                                <span style="font-size: small; padding-top: 4px;">íŒ”ë¡œì›Œ ì±— í™œì„±í™”</span>
                                <input type="checkbox" id="switch1">
                                <label for="switch1" class="switch_label">
                                    <span class="onf_btn"></span>
                                </label>
                            </div>
                        </li>
                        <li class="tmtm">
                            <div class="wrapper flexAndBetween">
                                <span style="font-size: small; padding-top: 4px;">ìµëª…ì±„íŒ…</span>
                                <input type="checkbox" id="switch2">
                                <label for="switch2" class="switch_label">
                                    <span class="onf_btn"></span>
                                </label>
                            </div>
                        </li>
                        <li>
                            <div class="wrapper flexAndBetween">
                                <span style="font-size: small; padding-top: 4px;">ìŠ¤íŠ¸ë¦¬ë¨¸ë§Œ ì±„íŒ… (ì–¼ë¦¬ê¸°)</span>
                                <input type="checkbox" id="switch3">
                                <label for="switch3" class="switch_label">
                                    <span class="onf_btn"></span>
                                </label>
                            </div>
                        </li>
                    </th:block>
                        <li>
                            <div class="wrapper flexAndBetween">
                                <span style="font-size: small; padding-top: 6px;">í°íŠ¸ í¬ê¸° ì¡°ì ˆ</span>
                                <div class="dropup">
                                    <button type="button" class="btn btn-sm" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                        <svg width="20" height="20" viewBox="0 0 20 20" focusable="false" aria-hidden="true" role="presentation" style="margin-right: 0%;">
                                            <path d="M10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"></path>
                                            <path fill-rule="evenodd" d="M9 2h2a2.01 2.01 0 0 0 1.235 1.855l.53.22a2.01 
                                            2.01 0 0 0 2.185-.439l1.414 1.414a2.01 2.01 0 0 0-.439 2.185l.22.53A2.01 2.01 
                                            0 0 0 18 9v2a2.01 2.01 0 0 0-1.855 1.235l-.22.53a2.01 2.01 0 0 0 .44 2.185l-1.415 
                                            1.414a2.01 2.01 0 0 0-2.184-.439l-.531.22A2.01 2.01 0 0 0 11 18H9a2.01 2.01 0 0 
                                            0-1.235-1.854l-.53-.22a2.009 2.009 0 0 0-2.185.438L3.636 14.95a2.009 2.009 0 0 
                                            0 .438-2.184l-.22-.531A2.01 2.01 0 0 0 2 11V9c.809 0 1.545-.487 1.854-1.235l.22-.53a2.009 
                                            2.009 0 0 0-.438-2.185L5.05 3.636a2.01 2.01 0 0 0 2.185.438l.53-.22A2.01 2.01 0 0 0 9 
                                            2zm-4 8 1.464 3.536L10 15l3.535-1.464L15 10l-1.465-3.536L10 5 6.464 6.464 5 10z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li class="dropdown-item" style="font-size: xx-large;" id="XXL">
                                            <span>ë…¸ì¸ë„¤ ì‚¬ì´ì¦ˆ</span>
                                        </li>
                                        <li class="dropdown-item" style="font-size: x-large;" id="XL">
                                            <span>ì•„ì£¼ í¬ê²Œ</span>
                                        </li>
                                        <li class="dropdown-item" style="font-size: large;" id="L">
                                            <span>í¬ê²Œ</span>
                                        </li>
                                        <li class="dropdown-item" style="font-size: medium;" id="M">
                                            <span>ì¤‘ê°„</span>
                                        </li>
                                        <li class="dropdown-item" style="font-size: small;" id="S">
                                            <span>ì‘ê²Œ</span>
                                        </li>
                                        <li class="dropdown-item" style="font-size: x-small;" id="XS">
                                            <span>ì•„ì£¼ ì‘ê²Œ</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="wrapper flexAndBetween">
                                <span style="font-size: small; padding-top: 2px;">ìŠ¤íŠ¸ë¦¬ë¨¸ë§Œ ì±„íŒ… (ì–¼ë¦¬ê¸°)</span>
                                <input type="checkbox" id="switch5">
                                <label for="switch5" class="switch_label">
                                    <span class="onf_btn"></span>
                                </label>
                            </div>
                        </li>
                </ul>
            </div>
            <button type="button" class="sendBtn btn btn-sm text-white flex-right" 
                style="background-color: blueviolet; margin-left: auto;" onclick="sendMsg()">ì „ì†¡</button>
        </div>
    </div>
</div>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="/docs/5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/js/switch.js"></script>
<script th:inline="javascript">
    
    const chatState = document.querySelector('.chatState').value;
    
    const channelId = document.querySelector('.dummy').value;
    
    // í˜„ì¬ í°íŠ¸ ì„¤ì •
    let element = document.querySelector('.dummy');
    

    // í°íŠ¸ ì„ íƒ
    const fontXxl = document.querySelector('#XXL');
    const fontXl = document.querySelector('#XL');
    const fontL = document.querySelector('#L');
    const fontM = document.querySelector('#M');
    const fontXs = document.querySelector('#XS');
    const fontS = document.querySelector('#S');
    
    fontXxl.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'xx-large'); 
        element.setAttribute('font-data', 'xx-large');  
    });
    fontXl.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'x-large');
        element.setAttribute('font-data', 'x-large');   
    });
    fontL.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'large');
        element.setAttribute('font-data', 'large');   
    });
    fontM.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'medium'); 
        element.setAttribute('font-data', 'medium');  
    });
    fontS.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'small');
        element.setAttribute('font-data', 'small'); 
    });
    fontXs.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'x-small');
        element.setAttribute('font-data', 'x-small');   
    });
    
    function enterRoom(socket){
        var enterMsg={"type" : "ENTER", "userType" : [[${userState}]], "roomId":[[${room.roomId}]],"sender":[[${userAccount.userNickname}]],"msg":""};
        console.log(enterMsg);
        socket.send(JSON.stringify(enterMsg));
        let user = [[${userAccount.userNickname}]];
        let entMsg = user + "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! BEEP!! BEEP!! BEEP!!"
        let msgArea = document.querySelector('.msgArea');
        let newMsg = document.createElement('div');
        if(user !== 'anonymousUser') {
            newMsg.innerText = entMsg;
            msgArea.append(newMsg);    
        } else if(user === 'anonymousUser') {
            newMsg.innerText = [[${streamer.userNickname}]] + "ë‹˜ì˜ ë°©ì†¡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!"
            msgArea.append(newMsg);
        }
    }
    
    let socket = new WebSocket("ws://192.168.20.26:8081/ws/chat");

    socket.onopen = function (e) {
        console.log('open server!')
        enterRoom(socket);
    }
    
    socket.onclose = function(e){
        console.log('disconnet');
    }

    socket.onerror = function (e){
        console.log(e);
    }

    function updateScroll() {
        var scroll = document.querySelector('.scrollbarContainer');
        scroll.scrollTop = scroll.scrollHeight;
    }
    
    let chatNo = 0;
    
    //ë©”ì„¸ì§€ ìˆ˜ì‹ í–ˆì„ ë•Œ ì´ë²¤íŠ¸.
    socket.onmessage = function (e) {
        chatNo += 1;
        
        console.log(e.data);
        console.log(chatNo);
        let msgArea = document.querySelector('.msgArea');
        let newMsg = document.createElement('div');

        let fontData = element.getAttribute('font-data');
        newMsg.className = 'chat';
        newMsg.style = 'display: flex;';
        
        if(fontData === 'xx-large') {
            newMsg.style.fontSize = 'xx-large'
        } else if(fontData === 'x-large') {
            newMsg.style.fontSize = 'x-large'
        } else if(fontData === 'large') {
            newMsg.style.fontSize = 'large'
        } else if(fontData === 'medium') {
            newMsg.style.fontSize = 'medium'
        } else if(fontData === 'small') {
            newMsg.style.fontSize = 'small'
        } else if(fontData === 'x-small') {
            newMsg.style.fontSize = 'x-small'
        }
        //JSON.parse()ëŠ” JSON ë¬¸ìì—´ì„ javascript ë¦¬í„°ëŸ´ ê°ì²´ í˜¹ì€ ë°°ì—´ë¡œ ë³€í™˜í•¨
        let message = JSON.parse(e.data);
        
        let sender = `
        <div class="dropdown">
            <span data-bs-toggle="dropdown" aria-expanded="false" class="chat btn btn-link" 
            style="color: black; text-decoration: none; padding: 0px; border: 0px; margin-bottom: 3px;">
                ${message.sender}
            </span>
            <ul class="dropdown-menu">
                <li>
                    <span class="dropdown-item chat ban" data-id="${message.sender}" id=${chatNo}>
                        ë„ˆ ë°´
                    </span>
                </li>
                <li>
                    <span class="dropdown-item chat manager" data-id="${message.sender}" id=${chatNo}>
                        ë„ˆ ë§¤ë‹ˆì €
                    </span>
                </li>
            </ul>             
        </div>`;
        
        // senderê°€ í•´ë‹¹ ì±„ë„ì˜ ìŠ¤íŠ¸ë¦¬ë¨¸ì¼ ê²½ìš° ê°•ì¡°í•´ì„œ í‘œì‹œ
        if(message.sender === [[${streamer.userNickname}]]) {
            newMsg.innerHTML = 'ğŸ‘‘' + '<strong>' + message.sender + ':' + message.msg + '</strong>';        
        } else if(message.userType === "FOLLOW") { // íŒ”ë¡œì›Œì¼ ê²½ìš° ì±„íŒ… ë³€ê²½
            newMsg.innerHTML = 'ğŸ‘ï¸' + sender + ':' + message.msg;
        } else if(message.userType === "NON_FOLLOW" || message.userType === "ANONYMOUS") {
            newMsg.innerHTML = message.sender + ':' + message.msg;
        }
        if(message.type === 'TALK') {
          msgArea.append(newMsg);
        }

        updateScroll();
        
        let banUser = document.querySelector(`span.ban[id="${chatNo}"]`)
        banUser.addEventListener('click', function() {
            let userNickname = banUser.getAttribute('data-id');
            
            const data = { userNickname, channelId };
            
            axios.post('/api/user/ban', data)
            .then((response) => {
                console.log(response);
            })
            .catch((error) => {
                console.log(error);
            });
            
        });
        
        let manager = document.querySelector(`span.manager[id="${chatNo}"]`)
        manager.addEventListener('click', function() {
            let userNickname = manager.getAttribute('data-id');
            
            const uri = '/api/user/manager/' + userNickname;
            console.log(uri, { params: { ChannelId: channelId } });
            axios.post('api/user/manager', channelId)
            .then((response) => {
                console.log(response);
            })
            .catch((error) => {
                console.log(error);
            });
            
        });
        
    }
    

    document.addEventListener('keydown', function(event) {
        if (event.keyCode === 13) {
            event.preventDefault(); // ê¸°ë³¸ Enter í–‰ë™ ë§‰ê¸° (í¼ ì „ì†¡ ë“±)
            sendMsg();
        }
    });
    
    //ë©”ì„¸ì§€ ë³´ë‚´ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë–„..
    function sendMsg() {
        let content=document.querySelector('.content').value;
        if(content === '') {
            return;
        }
        let userId = [[${userAccount.userNickname}]];
        let userType = [[${userState}]];
     
        if([[${userAccount.userNickname}]] === 'anonymousUser' && chatState !== '[ANONYMOUS]'){
            document.querySelector('.content').value = 'ì±„íŒ…ì€ ë¡œê·¸ì¸ ì´í›„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            document.querySelector('.content').setAttribute('readonly', 'true');
            return;
        } else if(userType === 'NON_FOLLOW' && chatState === '[FOLLOW]') {
            document.querySelector('.content').value = 'í˜„ì¬ ì±„íŒ…ë°©ì— íŒ”ë¡œìš°ì±—ì´ ì ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.';
            document.querySelector('.content').setAttribute('readonly', 'true');
            return;
        } else if(userType !== 'STREAMER' && chatState === '[STREAMER_ONLY]') {
            document.querySelector('.content').value = 'í˜„ì¬ ì±„íŒ…ë°©ì— ìŠ¤íŠ¸ë¦¬ë¨¸ì±—ì´ ì ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.';
            document.querySelector('.content').setAttribute('readonly', 'true');
            return;
        } 
    
        var talkMsg = {
                "type" : "TALK",
                "userType" : userType,
                "roomId":[[${room.roomId}]],
                "sender": userId,
                "msg":content};
    //JSON.stringify(quitMsg) -> json í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ì„œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ë©”ì„œë“œ.
        socket.send(JSON.stringify(talkMsg));
    
        document.querySelector('.content').value = '';

    }

    window.addEventListener('beforeunload', handlePageUnload);

    function quit(){
        var quitMsg={"type" : "QUIT", "userType" : [[${userState}]], "roomId":[[${room.roomId}]] ,"sender":[[${userAccount.userNickname}]],"msg":""};
        //JSON.stringify(quitMsg) -> json í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ì„œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ë©”ì„œë“œ.
        socket.send(JSON.stringify(quitMsg));
        socket.close();
        location.href="/";
    }

    function handlePageUnload() {
        quit();
    }


</script>
<script th:inline="javascript">
  const authentication = /*[[${#authentication.name}]]*/ null;
</script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/js/follow.js"></script>
<script src="/js/broadcast.js"></script>
</body>
</html>