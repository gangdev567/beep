<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Insert title here</title>
  <link rel="stylesheet" href="/css/sidebar.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="canonical" href="https://getbootstrap.kr/docs/5.3/examples/footers/">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.15.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/sidebar.css" >
  <link rel="stylesheet" href="/css/nav.css" >
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://kit.fontawesome.com/1306328925.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/nav.css" >
  <link rel="stylesheet" href="/css/switch.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
 /* 채팅 환영 메시지 스타일링 */
.msgArea div {
  margin-bottom: 5px;
  padding: 8px;
}



.msgArea div span {
  font-weight: bold;
}


 /* 전체 섹션 스타일 */
section.home {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-top: 40px; /* Navigation bar의 높이만큼 여백 추가 */
}

/* 비디오 컨테이너 스타일 */
.video-container {
  width: 70%; /* 비디오 컨테이너의 너비 조절 가능 */
  position: relative;
  margin-right: 20px; /* 비디오와 채팅 사이 간격 조절 가능 */
}

.video-container video {
  width: 1320px;
  height: auto;
  margin-left: 10px;
  display: block;
  border-radius: 8px;
}

/* 채팅 컨테이너 스타일 */
.cnter-item:last-child {
  width: 30%; /* 채팅 컨테이너의 너비 조절 가능 */
  display: flex;
  flex-direction: column;
  height: 100%;
}

.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* 채팅 컨테이너 스타일 추가 및 수정 */
.cnter-item:last-child {
  position: fixed; /* 화면 상단에 고정 */
  top: 60px; /* 화면 상단에 고정시키기 위한 값 */
  right: 0; /* 화면 우측에 고정시키기 위한 값 */
  color: #ffffff; /* 글자색 변경 */
  width: 320px;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5); /* 그림자 효과 */
  overflow: hidden; /* 넘치는 내용 감추기 */
  z-index: 999; /* 다른 요소 위에 표시 */
}

/* 텍스트에리아 스타일링 */
textarea {
  width: 100%;
  min-height: 50px; /* 최소 높이 (조절 가능) */
  max-height: 150px; /* 최대 높이 (조절 가능) */
  padding: 10px;
  border: 2px solid #2c3e50; /* 다크 테마 테두리 색상 */
  border-radius: 8px;
  margin-top: 5px; /* 수정: 5px로 변경 */
  background-color: #34495e; /* 다크 테마 배경색 */
  color: #ecf0f1; /* 다크 테마 글자색 */
  resize: none;
  outline: none;
  transition: border-color 0.3s; /* 테두리 색상 변화 애니메이션 */
  overflow-y: hidden; /* 세로 스크롤을 감춤 */
  box-sizing: border-box; /* 패딩, 테두리를 요소의 너비와 높이에 포함 */
  line-height: 1.5; /* 줄 높이 (조절 가능) */
  font-size: 14px; /* 글자 크기 (조절 가능) */
}

/* 포커스 시 테두리 색상 변화 */
textarea:focus {
  border-color: #3498db; /* 포커스 시 테두리 색상 변경 */
}

/* Form 내의 input 스타일링 */
.input-group-sm > .form-control {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 2px solid #34495e; /* 다크 테마 테두리 색상 */
  border-radius: 8px;
  background-color: #fff; /* 다크 테마 배경색 */
  color: #24262a; /* 다크 테마 글자색 */
  transition: border-color 0.3s; /* 테두리 색상 변화 애니메이션 */
}

/* Input 포커스 시 테두리 및 박스 쉐도우 스타일링 */
.input-group-sm > .form-control:focus {
  outline: none;
  border-color: #dfe2ea; /* 포커스 시 테두리 색상 (더 밝은 파란색) */
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* 포커스 시 박스 쉐도우 (조절 가능) */
}






/* 입력창 내부 애니메이션 */
.input-group:focus-within textarea {
  transition: height 0.3s, border-color 0.3s; /* 높이 및 테두리 색상 변화 애니메이션 */
  border-color: #3498db; /* 포커스 시 테두리 색상 변경 */
}

/* 플레이스홀더 스타일링 */
textarea::placeholder {
  color: #95a5a6; /* 플레이스홀더 색상 (조절 가능) */
}
/* 텍스트에리아 내용에 따라 늘어나게 하기 */
textarea:focus {
  height: auto;
}



/* 입력창 내부 애니메이션 */
.input-group:focus-within textarea {
  transition: height 0.3s, border-color 0.3s; /* 높이 및 테두리 색상 변화 애니메이션 */
  border-color: #3498db; /* 포커스 시 테두리 색상 변경 */
}
/* 이모지 스타일링 */
.emoji {
  font-size: 20px; /* 이모지 크기 */
  margin-right: 5px; /* 이모지 간격 조절 */
}
/* 이모지 애니메이션 효과 */
.emoji {
  opacity: 0;
  animation: fadeIn 0.5s ease-in-out forwards;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

/* 스크롤바 스타일 */
.scrollbarContainer {

  overflow-y: scroll; /* 스크롤 항상 표시 */
  padding: 10px;
  border-radius: 8px;
  flex-grow: 1;
  scroll-behavior: smooth; /* 자동으로 스크롤 이동 애니메이션 적용 */
  max-height: 500px; /* 적절한 높이로 설정 (조절 가능) */
}

/* 채팅창 내부 스타일링 */
.msgArea {
  scroll-snap-type: y mandatory;
  animation: scrollDown 0.5s ease-out; /* 스크롤이 최하단으로 이동하는 애니메이션 추가 */
}

/* 스크롤 이동 애니메이션 keyframes */
@keyframes scrollDown {
  to {
    transform: translateY(calc(-100%)); /* 100%만큼 이동 */
  }
}

/* 입력창 및 전송 버튼 스타일 */
.input-group {
  margin-top: 10px;
}

.sendBtn {
  display: none;
}

/* 추가된 부분 폰트 크기 조절 스타일 */
.dropdown-menu li {
  padding: 5px;
}
  </style>
</head>
<body>
<div th:replace="~{/layout/fragments :: myheader}"></div>
<div th:replace="~{/layout/fragments :: mysidebar}"></div>
<div class="void" >
    <input class="dummy"d-none th:value="${channel.channelId}" font-data="medium" auth-data="">
</div>
<section class="home">
      <!-- 스트리밍 플레이어 추가 -->
<div class="video-container">
    <video id="video" controls autoplay></video>
    <div style="margin-left: 10px; color: white;">
        <div class="align-items-center d-flex my-3">
            <div class="position-relative">
                <img id="channelImage" class="channelImageStyle my-3 img-fluid rounded-circle me-3 position-relative z-index-1" alt="channelImg" th:src="${channel.channelProfileImg}" style="width: 75px; height: 75px;">
                <span id="liveBadge" class="position-absolute bottom-0 start-50 translate-middle badge bg-danger d-none" style="transform: translate(-50%, 50%);">LIVE</span>
            </div>
            <div>
                <span class="fw-bold d-block mb-1 fs-5" th:text="${channel.channelUserAccountEntity.userNickname}"></span>
                <span class="d-block mb-1" th:text="${channel.channelTitle}"></span>
                <span class="d-block mb-1" th:text="${channel.categoryEntityOfChannel.categoryName}"></span>
                <small class="d-block" th:text="|${channel.channelViewerCount} 명 시청중|"></small>
            </div>
            <div style="position: absolute; left: 1300px;">
                <input class="d-none" id="authentication" th:value="${#authentication != null ? #authentication.name : null}" />
                <input class="d-none" id="channelUserId" th:value="${streamer.userId}" />
                <input class="d-none" id="channelUserNickname" th:value="${streamer.userNickname}" />
                <input class="d-none" id="loginUserId" th:value="${userAccount.userId}"/>
                <input class="d-none" id="channelStateSet" th:value="${channel.streamingStateSet}"/>
                <button id="followBtn" type="button" class="btn btn-outline-primary mb-2" onclick="follow()"><i class="fas fa-heart"></i></button>
                <button id="unfollowBtn" type="button" class="btn btn-outline-danger d-none" onclick="unfollow()"><i class="fas fa-heart-broken"></i></button>
            </div>
        </div>
    </div>
</div>
<script>
const channelStateSet = document.getElementById('channelStateSet');
const channelImage = document.getElementById('channelImage');
const liveBadge = document.getElementById('liveBadge');

if (channelStateSet.value.includes('ON')) {
    liveBadge.classList.remove('d-none');
    if (channelImage) {
        channelImage.style.border = '5px solid #05BB83';
    }
}
</script>
      <script th:inline="javascript">
        /*<![CDATA[*/
        const videoSrc = [[${streamingUrl}]];
        const video = document.getElementById('video');

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(videoSrc);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = videoSrc;
        }
        /*]]>*/
      </script>
     
   
      
    <div class="cnter-item">
      <div class="chat-container">
        <div class="scrollbarContainer">
          <div class="msgArea"></div>
        </div>
        <div class="input-group input-group-sm">
          <textarea  type="text" placeholder="보낼 메세지를 입력하세요." class="form-control content" rows="2" style="margin-bottom: 5px;" maxlength="1000"></textarea>
        </div>
        <div class="flexAndBetween">
          <input class="chatState" style="display: none;" th:value="${chatState}">
          <div class="dropup">
           <button type="button" class="btn btn-sm" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
              <svg width="20" height="20" viewBox="0 0 20 20" focusable="false" aria-hidden="true" role="presentation" style="margin-right: 0%;">
                <path fill="#ffffff" d="M10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"></path>
                <path fill="#ffffff" fill-rule="evenodd" d="M9 2h2a2.01 2.01 0 0 0 1.235 1.855l.53.22a2.01 2.01 0 0 0 2.185-.439l1.414 1.414a2.01 2.01 0 0 0-.439 2.185l.22.53A2.01 2.01 0 0 0 18 9v2a2.01 2.01 0 0 0-1.855 1.235l-.22.53a2.01 2.01 0 0 0 .44 2.185l-1.415 1.414a2.01 2.01 0 0 0-2.184-.439l-.531.22A2.01 2.01 0 0 0 11 18H9a2.01 2.01 0 0 0-1.235-1.854l-.53-.22a2.009 2.009 0 0 0-2.185.438L3.636 14.95a2.009 2.009 0 0 0 .438-2.184l-.22-.531A2.01 2.01 0 0 0 2 11V9c.809 0 1.545-.487 1.854-1.235l.22-.53a2.009 2.009 0 0 0-.438-2.185L5.05 3.636a2.01 2.01 0 0 0 2.185.438l.53-.22A2.01 2.01 0 0 0 9 2zm-4 8 1.464 3.536L10 15l3.535-1.464L15 10l-1.465-3.536L10 5 6.464 6.464 5 10z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <ul class="dropdown-menu" style="width: 15vw">
              <li class="tmtm">
                <div class="wrapper flexAndBetween">
                  <span style="font-size: small; padding-top: 4px;">팔로워 챗 활성화</span>
                  <input type="checkbox" id="switch1">
                  <label for="switch1" class="switch_label">
                    <span class="onf_btn"></span>
                  </label>
                </div>
              </li>
              <li class="tmtm">
                <div class="wrapper flexAndBetween">
                  <span style="font-size: small; padding-top: 4px;">익명채팅</span>
                  <input type="checkbox" id="switch2">
                  <label for="switch2" class="switch_label">
                    <span class="onf_btn"></span>
                  </label>
                </div>
              </li>
              <li>
                <div class="wrapper flexAndBetween">
                  <span style="font-size: small; padding-top: 4px;">스트리머만 채팅 (얼리기)</span>
                  <input type="checkbox" id="switch3">
                  <label for="switch3" class="switch_label">
                    <span class="onf_btn"></span>
                  </label>
                </div>
              </li>
              <!-- 추가된 부분 -->
              <li>
                <div class="wrapper flexAndBetween">
                  <span style="font-size: small; padding-top: 2px;">폰트 크기 조절</span>
                  <div class="dropup">
                    <button type="button" class="btn btn-sm" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                      <svg width="20" height="20" viewBox="0 0 20 20" focusable="false" aria-hidden="true" role="presentation" style="margin-right: 0%;">
                        <path d="M10 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"></path>
                        <path fill-rule="evenodd" d="M9 2h2a2.01 2.01 0 0 0 1.235 1.855l.53.22a2.01 
                                            2.01 0 0 0 2.185-.439l1.414 1.414a2.01 2.01 0 0 0-.439 2.185l.22.53A2.01 2.01 
                                            0 0 0 18 9v2a2.01 2.01 0 0 0-1.855 1.235l-.22.53a2.01 2.01 0 0 0 .44 2.185l-1.415 
                                            1.414a2.01 2.01 0 0 0-2.184-.439l-.531.22A2.01 2.01 0 0 0 11 18H9a2.01 2.01 0 0 
                                            0-1.235-1.854l-.53-.22a2.009 2.009 0 0 0-2.185.438L3.636 14.95a2.009 2.009 0 0 
                                            0 .438-2.184l-.22-.531A2.01 2.01 0 0 0 2 11V9c.809 0 1.545-.487 1.854-1.235l.22-.53a2.009 
                                            2.009 0 0 0-.438-2.185L5.05 3.636a2.01 2.01 0 0 0 2.185.438l.53-.22A2.01 2.01 0 0 0 9 
                                            2zm-4 8 1.464 3.536L10 15l3.535-1.464L15 10l-1.465-3.536L10 5 6.464 6.464 5 10z" clip-rule="evenodd"></path>
                      </svg>
                    </button>
                    <ul class="dropdown-menu">
                      <li class="dropdown-item" style="font-size: xx-large;" id="XXL">
                        <span>노인네 사이즈</span>
                      </li>
                      <li class="dropdown-item" style="font-size: x-large;" id="XL">
                        <span>아주 크게</span>
                      </li>
                      <li class="dropdown-item" style="font-size: large;" id="L">
                        <span>크게</span>
                      </li>
                      <li class="dropdown-item" style="font-size: medium;" id="M">
                        <span>중간</span>
                      </li>
                      <li class="dropdown-item" style="font-size: small;" id="S">
                        <span>작게</span>
                      </li>
                      <li class="dropdown-item" style="font-size: x-small;" id="XS">
                        <span>아주 작게</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </li>
              <!-- 추가된 부분 끝 -->
              <li>
                <div class="wrapper flexAndBetween">
                  <span style="font-size: small; padding-top: 2px;">스트리머만 채팅 (얼리기)</span>
                  <input type="checkbox" id="switch5">
                  <label for="switch5" class="switch_label">
                    <span class="onf_btn"></span>
                  </label>
                </div>
              </li>
            </ul>
          </div>
          <button type="button" class="sendBtn btn btn-sm text-white flex-right" style="background-color: blueviolet; margin-left: auto;" onclick="sendMsg()">전송</button>
        </div>
      </div>
    </div>
    
</section>
<div>
    <footer th:replace="layout/fragments :: myfooter"></footer>
</div>
<script th:replace="~{layout/fragments :: sidebar_js}"></script>
<script th:replace="~{layout/fragments :: bootstrap_js}"></script>
<script src="/js/fragments-categories-search.js"></script>
<script src="/js/sse.js"></script>
<script src="/js/switch.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/js/follow.js"></script>
<script src="/js/broadcast.js"></script>
<script th:inline="javascript">
   
    window.addEventListener("DOMContentLoaded", loadUserAuth());

    function loadUserAuth() {
        
        let userNickname = [[${userAccount.userNickname}]]; 
        let channelId = [[${channel.channelId}]];
        
        axios.get('/api/user/auth', { params: { channelId: channelId } })
                    .then((response) => {
                        let data = response.data;
                        
                        const element = document.querySelector('.dummy');
                        
                        element.setAttribute('auth-data', data);
                        
                    })
                    .catch((error) => {
                        console.log(error);
                    });
    }
    
    const channelId = document.querySelector('.dummy').value;
    
    // 현재 폰트 설정
    let element = document.querySelector('.dummy');
    

    // 폰트 선택
    const fontXxl = document.querySelector('#XXL');
    const fontXl = document.querySelector('#XL');
    const fontL = document.querySelector('#L');
    const fontM = document.querySelector('#M');
    const fontXs = document.querySelector('#XS');
    const fontS = document.querySelector('#S');
    
    fontXxl.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'xx-large'); 
        element.setAttribute('font-data', 'xx-large');  
    });
    fontXl.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'x-large');
        element.setAttribute('font-data', 'x-large');   
    });
    fontL.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'large');
        element.setAttribute('font-data', 'large');   
    });
    fontM.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'medium'); 
        element.setAttribute('font-data', 'medium');  
    });
    fontS.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'small');
        element.setAttribute('font-data', 'small'); 
    });
    fontXs.addEventListener('click', function() {
        let chat = document.querySelectorAll('.chat');
        chat.forEach(x => x.style.fontSize = 'x-small');
        element.setAttribute('font-data', 'x-small');   
    });
    
    function enterRoom(socket) {
        var enterMsg = {
            "type": "ENTER",
            "userType": [[${userState}]],
            "veiwers": 0,
            "roomId": [[${room.roomId}]],
            "sender": [[${userAccount.userNickname}]],
            "message": ""
        };
        console.log(enterMsg);
        socket.send(JSON.stringify(enterMsg));

        let user = [[${userAccount.userNickname}]];
        let entMsg = user + "님 환영합니다!";
        let msgArea = document.querySelector('.msgArea');
        let newMsg = document.createElement('div');

        if (user !== 'anonymousUser') {
            newMsg.innerText = entMsg;
            newMsg.style.color = '#3498db'; // 적절한 색상으로 변경
            msgArea.append(newMsg);
        } else if (user === 'anonymousUser') {
            newMsg.innerText = [[${streamer.userNickname}]] + "님의 방송에 오신 것을 환영합니다!";
            newMsg.style.color = '#e74c3c'; // 적절한 색상으로 변경
            msgArea.append(newMsg);
        }
    }
    
    let socket = new WebSocket("ws://192.168.20.26:8081/ws/chat");

    socket.onopen = function (e) {
        console.log('open server!')
        enterRoom(socket);
    }
    
    socket.onclose = function(e){
        console.log('disconnet');
    }

    socket.onerror = function (e){
        console.log(e);
    }

    function updateScroll() {
        var scroll = document.querySelector('.scrollbarContainer');
        scroll.scrollTop = scroll.scrollHeight;
    }
    
    let chatNo = 0;
    
    //메세지 수신했을 때 이벤트.
    socket.onmessage = function (e) {
        chatNo += 1;
        
        console.log(e.data);
        console.log(chatNo);
        let msgArea = document.querySelector('.msgArea');
        let newMsg = document.createElement('div');

        let fontData = element.getAttribute('font-data');
        newMsg.className = 'chat';
        newMsg.style = 'display: flex;';
        
        if(fontData === 'xx-large') {
            newMsg.style.fontSize = 'xx-large'
        } else if(fontData === 'x-large') {
            newMsg.style.fontSize = 'x-large'
        } else if(fontData === 'large') {
            newMsg.style.fontSize = 'large'
        } else if(fontData === 'medium') {
            newMsg.style.fontSize = 'medium'
        } else if(fontData === 'small') {
            newMsg.style.fontSize = 'small'
        } else if(fontData === 'x-small') {
            newMsg.style.fontSize = 'x-small'
        }
        //JSON.parse()는 JSON 문자열을 javascript 리터럴 객체 혹은 배열로 변환함
        let message = JSON.parse(e.data);
        
        if(message.sender === [[${streamer.userNickname}]] && message.message === [[${userAccount.userNickname}]] + '님이 매니저로 임명되었습니다.') {
            loadUserAuth();
        } else if (message.sender === [[${streamer.userNickname}]] && message.message === [[${userAccount.userNickname}]] + '님이 매니저에서 해임되었습니다.') {
            loadUserAuth();
        }
        
        let elemental = document.querySelector('.dummy');
        let userAuth = elemental.getAttribute('auth-data');
        
        let sender = `
        <div class="dropdown">
            <span data-bs-toggle="dropdown" aria-expanded="false" class="chat btn btn-link" 
            style="color: black; text-decoration: none; padding: 0px; border: 0px; margin-bottom: 3px;">
                ${message.sender}
            </span>
            <ul class="dropdown-menu">
                <li>
                    <span class="dropdown-item chat ban" data-id="${message.sender}" id=${chatNo}>
                        너 밴
                    </span>
                </li>`;
        if([[${userAccount.userNickname}]] === [[${streamer.userNickname}]] && message.userType === 'MANAGER') {
            sender += 
                `<li>
                    <span class="dropdown-item chat managerRevoke" data-id="${message.sender}" id=${chatNo}>
                        매니저 권한 취소
                    </span>
                </li>`;
        }
        if([[${userAccount.userNickname}]] === [[${streamer.userNickname}]] && message.userType !== 'MANAGER') {
            sender += 
                `<li>
                    <span class="dropdown-item chat manager" data-id="${message.sender}" id=${chatNo}>
                        너 매니저
                    </span>
                </li>`;
        }
        sender += 
        `   </ul>             
        </div>`;
        
     // 랜덤 색상 매핑 객체
        let colorMapping = {};

        // 랜덤 색상 생성 함수
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // sender가 해당 채널의 스트리머일 경우 강조해서 표시
        if (message.sender === [[${streamer.userNickname}]]) {
            newMsg.innerHTML = '👑' + '<strong>' + message.sender + ':' + message.message + '</strong>';
        } else {
            let senderDisplayName = message.sender;

            // 저장된 닉네임에 대한 랜덤 색상 확인
            let senderColor = colorMapping[senderDisplayName];

            // 색상이 없다면 새로운 랜덤 색상 생성
            if (!senderColor) {
                senderColor = getRandomColor();
                colorMapping[senderDisplayName] = senderColor;
            }

            // 채팅 타입에 따라 닉네임과 메시지 출력
            if (message.userType === "MANAGER") {
                senderDisplayName = '⚔' + senderDisplayName;
            } else if (message.userType === "FOLLOW") { // 팔로워일 경우 채팅 변경
                senderDisplayName = '👍︎' + senderDisplayName;
            }

            newMsg.innerHTML = `<span style="color: ${senderColor};">${senderDisplayName}:</span> ${message.message}`;
        }

        if (message.type === 'TALK') {
            msgArea.append(newMsg);
        }

        updateScroll();
        
        let banUser = document.querySelector(`span.ban[id="${chatNo}"]`);
        if (banUser !== null) {            
            banUser.addEventListener('click', function ban() {
                let auth = elemental.getAttribute('auth-data');
                
                if(auth === 'MANAGER' || [[${streamer.userNickname}]] === [[${userAccount.userNickname}]]) {
                    
                    let userNickname = banUser.getAttribute('data-id');
                    
                    const data = { userNickname, channelId };
                    
                    axios.post('/api/user/ban', data)
                    .then((response) => {
                        console.log(response);
                        let userNickname = banUser.getAttribute('data-id');
                        document.querySelector('.content').value = userNickname + '님이 밴 되었습니다.';
                        sendMsg();
                    })
                    .catch((error) => {
                        console.log(error);
                    });
                    
                }
                
                
            });
        }
        
        let manager = document.querySelector(`span.manager[id="${chatNo}"]`)
        if (manager !== null) {            
            manager.addEventListener('click', function() {
                let userNickname = manager.getAttribute('data-id');
                
                const data = { userNickname, channelId };
               
                axios.post('/api/user/manager', data)
                .then((response) => {
                    console.log(response);
                    let userNickname = manager.getAttribute('data-id');
                    document.querySelector('.content').value = userNickname + '님이 매니저로 임명되었습니다.';
                    sendMsg();
                })
                .catch((error) => {
                    console.log(error);
                });
                
            });
        }
        
        let managerRevoke = document.querySelector(`span.managerRevoke[id="${chatNo}"]`)
        if (managerRevoke !== null) {            
            managerRevoke.addEventListener('click', function() {
                let userNickname = managerRevoke.getAttribute('data-id');
                
                const data = { userNickname, channelId };
               
                axios.post('/api/user/managerRevoke', data)
                .then((response) => {
                    console.log(response);
                    let userNickname = managerRevoke.getAttribute('data-id');
                    document.querySelector('.content').value = userNickname + '님이 매니저에서 해임되었습니다.';
                    sendMsg();
                })
                .catch((error) => {
                    console.log(error);
                });
                
            });
        }
        
    }
    

    document.addEventListener('keydown', function(event) {
        if (event.keyCode === 13) {
            event.preventDefault(); // 기본 Enter 행동 막기 (폼 전송 등)
            sendMsg();
        }
    });
    
    //메세지 보내기 버튼 눌렀을 떄..
    function sendMsg() {
        let content=document.querySelector('.content').value;
        if(content === '') {
            return;
        }
        
        const uri = '/api/chat/chatState/' + channelId;
        
        axios.get(uri)
        .then((response) => {
            let data = response.data;
            let userId = [[${userAccount.userNickname}]];
            let userType = data.userType;
         
            if (userType === 'BAN') {
                document.querySelector('.content').value = '해당 방송에서 채팅 권한을 박달당하셨습니다. ㅠㅠ';
                return;
            } else if([[${userAccount.userNickname}]] === 'anonymousUser' && data.chatState !== '[ANONYMOUS]'){
                document.querySelector('.content').value = '채팅은 로그인 이후 이용하실 수 있습니다.';
                return;
            } else if(userType === 'NON_FOLLOW' && data.chatState === '[FOLLOW]') {
                document.querySelector('.content').value = '현재 채팅방에 팔로우챗이 적용되고 있습니다.';
                return;
            } else if(userType !== 'STREAMER' && data.chatState === '[STREAMER_ONLY]') {
                document.querySelector('.content').value = '현재 채팅방에 스트리머챗이 적용되고 있습니다.';
                return;
            }
        
            var talkMsg = {
                    "type" : "TALK",
                    "userType" : userType,
                    "roomId":[[${room.roomId}]],
                    "sender": userId,
                    "message":content};
            //JSON.stringify(quitMsg) -> json 형식으로 데이터를 전송하기 위해서 문자열로 변환하는 메서드.
            socket.send(JSON.stringify(talkMsg));
        
            document.querySelector('.content').value = '';
        })
        .catch((error) => {
            console.log(error);
        });
    }

    window.addEventListener('beforeunload', handlePageUnload);

    function quit(){
        var quitMsg={"type" : "QUIT", 
                    "userType" : [[${userState}]], 
                    "roomId":[[${room.roomId}]] ,
                    "sender":[[${userAccount.userNickname}]],
                    "message":""};
        //JSON.stringify(quitMsg) -> json 형식으로 데이터를 전송하기 위해서 문자열로 변환하는 메서드.
        socket.send(JSON.stringify(quitMsg));
        socket.close();
        location.href="/";
    }

    function handlePageUnload() {
        quit();
    }
    // 추가된 부분: 랜덤으로 색상을 생성하는 함수
    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }


</script>
<script th:inline="javascript">
  const authentication = /*[[${#authentication.name}]]*/ null;
</script>


</body>
</html>